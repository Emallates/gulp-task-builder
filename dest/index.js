var gulp=require("gulp"),async=require("async"),plugins=require("gulp-load-plugins")({pattern:["gulp-*","gulp.*","main-bower-files","run-sequence"],replaceString:/\bgulp[\-.]/}),builder=function(){this.activeTasksList=[]};builder.prototype.getTasks=function(){return this.activeTasksList},builder.prototype.runTask=function(e,r){r=r||function(){},plugins.runSequence(e,r)},builder.prototype.runTasks=function(e){var r=this,t=e&&r.isArray(e)?e:r.activeTasksList;for(var p in t)r.runTask(t[p])},builder.prototype._isObject=function(e){return"object"==typeof e&&null!==e},builder.prototype.isArray=Array.isArray||function(e){return e instanceof Array&&e.constructor.toString().indexOf("Array")>-1},builder.prototype.initTask=function(e,r){var t=this;r.name=r.name||e,r.preRun?(r.preRun=t.isArray(r.preRun)?r.preRun:[r.preRun],t.runTask(r.preRun,function(){gulp.task(e,t.buildTask(r))})):gulp.task(e,t.buildTask(r)),t.activeTasksList.push(e),r.watch&&gulp.watch(r.src,[e])},builder.prototype.buildTasks=function(e){var r=this;if(!r.isArray(e)&&!r._isObject(e))return void console.log("Invalid tasks list...!");for(var t in e)r.initTask(e[t].name||t,e[t])},builder.prototype.buildTask=function(e){var r=this;return function(){var t=gulp.src(e.src).on("error",console.log);if(e.filter&&(t=t.pipe(plugins.filter(e.filter))),e.preLog&&(t=t.pipe(plugins.intercept(function(r){return e.preLog="string"==typeof e.preLog?e.preLog:"contents",console.log(r[e.preLog].toString()),r}))),e.debug)switch(e.ext){case".js":t=t.pipe(plugins.plumber())}if(e.concat&&r._isObject(e.concat)){var p=e.concat.name||name;p+=e.concat.ext&&-1!=e.concat.ext.toString().indexOf(".")?e.concat.ext:e.ext,t=t.pipe(plugins.concat(p))}if(e.compress&&!r._isObject(e.compress))switch(e.ext){case".js":t=t.pipe(plugins.uglify());break;case".html":t=t.pipe(plugins.htmlmin({collapseWhitespace:!0}));break;case".css":t=t.pipe(plugins.cleanCss({compatibility:"ie8"}))}if(e.replace)if(r.isArray(e.replace))for(var i in e.replace){var s=e.replace[i];s.target&&s.src&&(t=t.pipe(plugins.replace(s.target,s.src))),s.options&&r._isObject(s.options)&&".html"==e.ext&&(t=t.pipe(plugins.htmlReplace(s.options)))}else r._isObject(e.replace)?(e.replace.target&&e.replace.src&&(t=t.pipe(plugins.replace(e.replace.target,e.replace.src))),e.replace.options&&r._isObject(e.replace.options)&&".html"==e.ext&&(t=t.pipe(plugins.htmlReplace(e.replace.options)))):console.log("replace skip of task"+name);if(e.rename&&(r._isObject(e.rename)||"function"==typeof e.rename?t=t.pipe(plugins.rename(e.rename)):console.log("rename skip of task "+name)),e.wrapper&&r._isObject(e.wrapper)){var n={};e.wrapper.header&&(n.header=e.wrapper.header),e.wrapper.footer&&(n.footer=e.wrapper.footer),t=t.pipe(plugins.wrapper(n))}if(e.compress&&r._isObject(e.compress)&&e.compress.post)switch(e.ext){case".js":t=t.pipe(plugins.uglify());break;case".html":t=t.pipe(plugins.htmlmin({collapseWhitespace:!0}));break;case".css":t=t.pipe(plugins.cleanCss({compatibility:"ie8"}))}e.postLog&&(t=t.pipe(plugins.intercept(function(r){return e.postLog="string"==typeof e.postLog?e.postLog:"contents",console.log(r[e.postLog].toString()),r}))),e.save&&(t=t.pipe(gulp.dest(e.dest))),console.log(e.name," job done")}},module.exports=builder;